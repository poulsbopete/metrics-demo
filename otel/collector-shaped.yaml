receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  memory_limiter:
    limit_mib: 256
    check_interval: 1s
    spike_limit_mib: 128

  # Remove high-cardinality labels
  attributes/delete:
    actions:
      - key: user_id
        action: delete
      - key: pod
        action: delete
      - key: container
        action: delete
      - key: instance
        action: delete
      - key: build_id
        action: delete
      - key: git_sha
        action: delete

  # Normalize path labels (replace /orders/12345 with /orders/{id})
  # Note: Path normalization is complex in OTTL, so we'll rely on the services
  # to send normalized paths in shaped mode. The attributes/delete processor
  # above already removes high-cardinality labels.
  transform/add_demo_mode:
    error_mode: ignore
    metric_statements:
      - context: resource
        statements:
          # Set demo.mode for easy filtering
          - set(attributes["demo.mode"], "shaped")

  # Optional: Filter out noisy metrics that aren't useful
  # filter/noisy_metrics:
  #   metrics:
  #     exclude:
  #       match_type: regexp
  #       metric_names:
  #         - "^go_.*"
  #         - "^process_.*"

  batch:
    timeout: 10s
    send_batch_size: 1024

  # Add Kubernetes attributes (but we've already removed pod/container)
  k8sattributes:
    auth_type: serviceAccount
    passthrough: true
    extract:
      labels:
        - tag_name: k8s.pod.label.app
          key: app
          from: pod
        - tag_name: k8s.namespace.name
          key: namespace
          from: pod

exporters:
  otlphttp/elastic:
    endpoint: ${ELASTIC_OTLP_ENDPOINT}
    headers:
      Authorization: "ApiKey ${ELASTIC_API_KEY}"
    tls:
      insecure: false
    # Optional: set dataset for routing
    # dataset: ${ELASTIC_DATASET}

extensions:
  health_check:
    endpoint: 0.0.0.0:13133

service:
  pipelines:
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, attributes/delete, transform/add_demo_mode, k8sattributes, batch]
      exporters: [otlphttp/elastic]

  extensions: [health_check]

#!/bin/bash
set -e

echo "Setting up Elastic Metrics Demo with local Elastic stack..."

# Install basic dependencies
export DEBIAN_FRONTEND=noninteractive
apt-get update -qq
apt-get install -y -qq curl wget git docker.io docker-compose jq build-essential > /dev/null 2>&1

# Start Docker service
systemctl start docker || service docker start || true
usermod -aG docker $USER || true

# Clone or copy the metrics-demo repository
if [ ! -d "/opt/metrics-demo" ]; then
    echo "Cloning metrics-demo repository..."
    git clone https://github.com/poulsbopete/metrics-demo.git /opt/metrics-demo || {
        echo "Repository clone failed, creating from local files..."
        mkdir -p /opt/metrics-demo
    }
fi

cd /opt/metrics-demo

# Set up local Elastic stack using start-local script
echo "Setting up local Elasticsearch and Kibana..."
if ! docker ps | grep -q elasticsearch; then
    echo "Starting local Elastic stack..."
    curl -fsSL https://elastic.co/start-local | sh || {
        echo "Failed to run start-local script, trying manual setup..."
        # Fallback: manual Docker Compose setup with reduced resources
        cat > /tmp/docker-compose-elastic.yml <<EOF
version: '3.8'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.2.3
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  kibana:
    image: docker.elastic.co/kibana/kibana:9.2.3
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - xpack.security.enabled=false
    ports:
      - "5601:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  es_data:
EOF
        docker compose -f /tmp/docker-compose-elastic.yml up -d
        echo "Waiting for Elasticsearch to be ready..."
        for i in {1..60}; do
            if curl -s http://localhost:9200 > /dev/null 2>&1; then
                echo "✓ Elasticsearch is ready"
                break
            fi
            sleep 2
        done
    fi
else
    echo "Elastic stack already running"
fi

# Wait for Elasticsearch to be ready
echo "Waiting for Elasticsearch..."
for i in {1..60}; do
    if curl -s http://localhost:9200 > /dev/null 2>&1; then
        echo "✓ Elasticsearch is ready"
        break
    fi
    sleep 2
done

# Configure for local Elastic
export ELASTIC_OTLP_ENDPOINT="http://localhost:4318"
export ELASTIC_API_KEY=""  # Not needed for local setup
export ELASTIC_DATASET=${ELASTIC_DATASET:-metrics-demo}

echo "Using local Elastic endpoint: http://localhost:9200"
echo "Kibana available at: http://localhost:5601"

# Create .env file for local Elastic
cat > .env <<EOF
ELASTIC_OTLP_ENDPOINT=http://host.docker.internal:9200
ELASTIC_API_KEY=
ELASTIC_DATASET=${ELASTIC_DATASET:-metrics-demo}
DEMO_MODE=${DEMO_MODE:-firehose}
USE_LOCAL_ELASTIC=true
EOF

# Install prerequisites if needed
if ! command -v kind &> /dev/null; then
    echo "Installing kind..."
    curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
    chmod +x ./kind
    sudo mv ./kind /usr/local/bin/kind
fi

if ! command -v kubectl &> /dev/null; then
    echo "Installing kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x kubectl
    sudo mv kubectl /usr/local/bin/kubectl
fi

if ! command -v docker &> /dev/null; then
    echo "ERROR: Docker is required but not installed"
    exit 1
fi

# Check if kind cluster exists
if kind get clusters | grep -q metrics-demo; then
    echo "Kind cluster 'metrics-demo' already exists"
else
    echo "Creating kind cluster..."
    ./scripts/setup-kind.sh || {
        echo "Creating kind cluster manually..."
        kind create cluster --name metrics-demo --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 8080
    hostPort: 8080
    protocol: TCP
EOF
    }
fi

# Set kubeconfig
export KUBECONFIG=$(kind get kubeconfig-path --name metrics-demo)

# Build and deploy
echo "Building Docker images..."
make build || {
    echo "Building images manually..."
    docker build -t frontend:latest ./services/frontend
    docker build -t api:latest ./services/api
    docker build -t worker:latest ./services/worker
}

echo "Loading images into kind..."
make load-kind || {
    echo "Loading images manually..."
    kind load docker-image frontend:latest --name metrics-demo
    kind load docker-image api:latest --name metrics-demo
    kind load docker-image worker:latest --name metrics-demo
}

echo "Deploying to Kubernetes..."
# Update deploy script to use local Elastic configs
export USE_LOCAL_ELASTIC=true
make deploy || ./scripts/deploy.sh

echo "Waiting for services to be ready..."
kubectl wait --for=condition=available --timeout=300s deployment/frontend -n elastic-metrics-demo || true
kubectl wait --for=condition=available --timeout=300s deployment/api -n elastic-metrics-demo || true
kubectl wait --for=condition=available --timeout=300s deployment/worker -n elastic-metrics-demo || true
kubectl wait --for=condition=available --timeout=300s deployment/otel-collector -n elastic-metrics-demo || true

echo ""
echo "✅ Metrics demo setup complete!"
echo ""
echo "To check status:"
echo "  kubectl get pods -n elastic-metrics-demo"
echo ""
echo "To access the demo UI:"
echo "  kubectl port-forward -n elastic-metrics-demo svc/frontend 8080:8080"
echo "  Then visit: http://localhost:8080/demo"
echo ""
echo "To switch modes:"
echo "  ./scripts/switch-mode.sh firehose"
echo "  ./scripts/switch-mode.sh shaped"
